<html>
	<header>
		<title>Advent of Code: Solutions</title>
	</header>
	<body>
		<div id="result" style="height:1em; background-color:lightgray; border:1px dashed black; padding:.2em; margin:.2em"></div>
		<select id="select"></select>
		<input id="button" type="button" value="Start"></input>
		<textarea id="sample" style="display:block; height:40em; width: 40em; margin-top:1em"></textarea>
		<script>
Array.prototype.cut = function(value) {
	do {
		var index = typeof value == "function"? this.findIndex(value) : this.indexOf(value);
		if (index >= 0) this.splice(index, 1);
	} while(index >= 0);
};
Array.prototype.visit = function(visitor) {
	this.forEach(visitor);
	return this;
};
Array.prototype.collect = function(reduction, initial) {
	return this.reduce((a,c) => {
		reduction(a,c);
		return a;
	}, initial||{});
};
Array.build = (size, supplier) => Array(size).fill().map((v,i)=>supplier(i));
const days = [{},
	{
		name: "Sonar Sweep",
		map: line => parseInt(line),
		easy: lines => lines.reduce((a,v,i) => (a + ((i > 0 && v > lines[i-1])? 1:0)), 0),
		hard: lines => days[1].easy(lines.map((v,i,l) => (l.slice(i,i+3).reduce((a,v) => a+v))))
	}, {
		name: "Dive! (Submarine Control)",
		up: (v,sm) => sm[sm.aimed? "a":"y"]-=v,
		down: (v,sm) => sm[sm.aimed? "a":"y"]+=v,
		forward: (v,sm) => (sm.x+=v)&&(sm.aimed? sm.y+=v*sm.a:false),
		map: line => line.split(" "),
		easy: {},
		hard: {aimed: true},
		calc: (lines, temp) => (r=> r.x*r.y)(lines.collect((a,c) => days[2][c[0]](parseInt(c[1]),a), Object.assign({a:0,x:0,y:0}, temp)))
	}, {
		name: "Binary Diagnostic",
		map: line => [...line].map(c => parseInt(c)),
		easy: lines => (r => parseInt(r.join(""),2) * parseInt(r.map(l=>1-l).join(""),2))(lines.reduce((a,c)=> c.map((v,i)=>v+a[i])).map(v => v > (lines.length/2)? 1:0)),
		hard: lines => days[3].hardFilter(lines,true)*days[3].hardFilter(lines,false),
		hardFilter: (lines,invert) => {
			for (var i = 0; lines.length > 1; i++) {
				var commonBit = lines.map(l => l[i]).reduce((a,c)=>a+c) >= (lines.length/2)? (invert?0:1):(invert?1:0);
				lines = lines.filter(l => l[i] == commonBit);
			}
			return parseInt(lines[0].join(""),2);
		}
	}, {
		name: "Giant Squid (Bingo!)",
		board: {
			add: function(line) { this.r.push(line.split(" ").filter(n => n.length > 0).map(n => parseInt(n)).visit((n,i) => this.c[i].push(n))) },
			mark: function(number) { this.c.concat(this.r).forEach(a => a.cut(number)) },
			isFinished: function() { return this.c.some(a => a.length == 0) || this.r.some(a => a.length == 0) }
		},
		easy: bs => bs.find(b => b.isFinished()),
		hard: bs => bs.length == 1? (bs.find(b => b.isFinished())):(bs.cut(b => b.isFinished())),
		calc: function(lines, winCon) {
			var number, numbers = lines[0].split(",").map(n => parseInt(n));
			var board, boards = [];
			for (var i = 1; i < lines.length; i++) lines[i].length? board.add(lines[i]):boards.push(board = Object.assign({}, days[4].board, {c:[[],[],[],[],[]],r:[]}));
			for (var i = 0, board = null; !board; i++)  board = winCon(boards.visit(b => b.mark(number = numbers[i])));
			return board.c.flat().reduce((a,c)=>a+c) * number;
		}
	}, {
		name: "Vent Lines",
		map: line => line.split(" -> ").map(s => s.split(",").map(s => parseInt(s))),
		easy: (f,t) => f[0]==t[0] || f[1]==t[1],
		hard: (f,t) => true,
		points: (f,t) => Array.build(Math.max(Math.abs(f[0]-t[0]),Math.abs(f[1]-t[1]))+1, i => Array.build(2,n => f[n]+i*(f[n]>t[n]?-1:(f[n]<t[n]?1:0)))),
		calc: (lines, valid) => Object.entries(lines.filter(l => valid(...l)).collect((a,l) => days[5].points(...l).forEach(p => a[p]?a[p]++:a[p]=1))).filter(e => e[1]>=2).length
	}, {
		name: "Lanternfish Growth Monitor",
		easy: 80,
		hard: 256,
		calc: (line, depth) => {
			var f = line.split(",").map(s => parseInt(s)).collect((a,c) => a[c]++, Array(9).fill(0));
			for (var i = 0; i < depth; i++) f[(7+i)%9] += f[i%9];
			return f.reduce((a,c) => a+c);
		}
	}, {
		name: "Crab Alignment",
		map: line => line.split(",").map(s => parseInt(s)),
		easy: d => d,
		hard: d => d*((d+1)/2),
		calc: (line, d) => Array.build(Math.max(...line), i => line.map(n => d(Math.abs(n-i))).reduce((a,c) => a+c)).sort((a,b) => a-b)[0]
	}
];
let $id = document.getElementById.bind(document),
	select = $id("select"),
	sample = $id("sample"),
	button = $id("button"),
	day = new Date().getDate(),
	store = ()=>sample.value = localStorage.getItem("simplygoat.aoc.sample."+select.value) || "";
days.forEach((e,i) => i>0? select.appendChild(Object.assign(document.createElement("option"), { value: i, innerHTML: `Day ${i}: ${e.name}`, selected: i==day? "selected":null })):null);
select.addEventListener("change", store, store());
button.addEventListener("click", () => {
	localStorage.setItem("simplygoat.aoc.sample."+select.value, sample.value);
	let t = performance.now(),
		d = days[select.value],
		l = sample.value.split("\n").filter((l,i,a) => i!=a.length-1||l.length).map(d.map||(e=>e)),
		r = (f,l)=>typeof f!="undefined"?(d.calc? d.calc(l.length==1? l[0]:l,f):f(l.length==1? l[0]:l)):"??";
	$id("result").innerHTML = `Results: ${r(d.easy,l)} / ${r(d.hard,l)} (${(performance.now()-t).toFixed(2)}ms)`;
});
		</script>
	</body>
</html>
