<html>
	<header>
		<title>Advent of Code: Solutions</title>
	</header>
	<body>
		<div id="result" style="height:1em; background-color:lightgray; border:1px dashed black; padding:.2em; margin:.2em"></div>
		<select id="select"></select>
		<input id="button" type="button" value="Start"></input>
		<textarea id="sample" style="display:block; height:40em; width: 40em; margin-top:1em"></textarea>
		<script>
Array.prototype.cut = function(value) {
	do {
		var index = typeof value == "function"? this.findIndex(value) : this.indexOf(value);
		if (index >= 0) this.splice(index, 1);
	} while(index >= 0);
};
Array.prototype.visit = function(visitor) {
	this.forEach(visitor);
	return this;
};
Array.prototype.collect = function(reduction, initial) {
	return this.reduce((a,c) => {
		reduction(a,c);
		return a;
	},initial||{});
};
Array.construct = (size, supplier) => Array(size).fill().map((v,i)=>supplier(i));
const days = [{},
	{
		name: "Sonar Sweep",
		map: line => parseInt(line),
		easy: lines => lines.reduce((a,v,i) => (a + ((i > 0 && v > lines[i-1])? 1:0)), 0),
		hard: lines => days[1].easy(lines.map((v,i,l) => (l.slice(i,i+3).reduce((a,v) => a+v))))
	}, {
		name: "Dive! (Submarine Control)",
		subMarine: {
			depth: 0, position: 0, aim: 0,
			up: function(value) { this[this.aimed? "aim":"depth"] -= value },
			down: function(value) { this.up(-value) },
			forward: function(value) {
				this.position += value;
				if(this.aimed) this.depth += this.aim * value;
			},
			result: function() { return this.position * this.depth }
		},
		map: line => line.split(" "),
		easy: {},
		hard: {aimed: true},
		calc: (lines, temp) => lines.collect((a, c) => a[c[0]](parseInt(c[1])), Object.assign({}, days[2].subMarine, temp)).result(),
	}, {
		name: "Binary Diagnostic",
		map: line => [...line].map(c => parseInt(c)),
		easy: lines => days[3].easyProduct(lines.reduce((a,c)=> c.map((v,i)=>v+a[i])).map(v => v > (lines.length/2)? 1:0).join("")),
		easyProduct: r => parseInt(r,2) * (~parseInt(r,2) & (Math.pow(2,r.length)-1)),
		hard: lines => days[3].hardFilter(lines,true)*days[3].hardFilter(lines,false),
		hardFilter: (lines,invert) => {
			for (var i = 0; lines.length > 1; i++) {
				var commonBit = lines.map(l => l[i]).reduce((a,c)=>a+c) >= (lines.length/2)? (invert?0:1):(invert?1:0);
				lines = lines.filter(l => l[i] == commonBit);
			}
			return parseInt(lines[0].join(""),2);
		}
	}, {
		name: "Giant Squid (Bingo!)",
		board: {
			add: function(line) { this.r.push(line.split(" ").filter(n => n.length > 0).map(n => parseInt(n)).visit((n,i) => this.c[i].push(n))) },
			mark: function(number) { this.c.concat(this.r).forEach(a => a.cut(number)) },
			isFinished: function() { return this.c.some(a => a.length == 0) || this.r.some(a => a.length == 0) }
		},
		easy: bs => bs.find(b => b.isFinished()),
		hard: bs => bs.length == 1? (bs.find(b => b.isFinished())):(bs.cut(b => b.isFinished())),
		calc: function(lines, winCon) {
			var number, numbers = lines[0].split(",").map(n => parseInt(n));
			var board, boards = [];
			for (var i = 1; i < lines.length; i++) lines[i].length? board.add(lines[i]):boards.push(board = Object.assign({}, days[4].board, {c:[[],[],[],[],[]],r:[]}));
			for (var i = 0, board = null; !board; i++)  board = winCon(boards.visit(b => b.mark(number = numbers[i])));
			return board.c.flat().reduce((a,c)=>a+c) * number;
		}
	}, {
		name: "Vent Lines",
		map: line => line.split(" -> ").map(s => s.split(",").map(s => parseInt(s))),
		easy: (f,t) => f[0]==t[0] || f[1]==t[1],
		hard: (f,t) => true,
		points: (f,t) => Array.construct(Math.max(Math.abs(f[0]-t[0]),Math.abs(f[1]-t[1]))+1, i => Array.construct(2,n => f[n]+i*(f[n]>t[n]?-1:(f[n]<t[n]?1:0)))),
		calc: (lines, valid) => Object.entries(lines.filter(l => valid(...l)).collect((a,l) => days[5].points(...l).forEach(p => a[p]?a[p]++:a[p]=1))).filter(e => e[1]>=2).length
	}, {
		name: "Lanternfish Growth Monitor",
		easy: 80,
		hard: 256,
		calc: (line, depth) => {
			var f = line.split(",").map(s => parseInt(s)).collect((a,c) => a[c]++, Array(9).fill(0));
			for (var i = 0; i < depth; i++) f[(7+i)%9] += f[i%9];
			return f.reduce((a,c) => a+c);
		}
	}, {
		name: "Crab Alignment",
		map: line => line.split(",").map(s => parseInt(s)),
		easy: d => d,
		hard: d => d*((d+1)/2),
		calc: (line, d) => Array.construct(Math.max(...line), i => line.map(n => d(Math.abs(n-i))).reduce((a,c) => a+c)).sort((a,b) => a-b)[0]
	}
];
const $id = document.getElementById.bind(document);
const select = $id("select"), sample = $id("sample");
const updateSample = ()=>sample.value = localStorage.getItem("simplygoat.aoc.sample."+select.value) || "";
const day = new Date().getDate();
days.forEach((e,i) => {
	if (i == 0) return;
	var opt = document.createElement("option");
	opt.value = i;
	opt.innerHTML = "Day " + i + ": " + e.name;
	if (i == day) opt.selected = "selected";
	select.appendChild(opt);
});
select.addEventListener("change", updateSample);
updateSample();
$id("button").addEventListener("click", function() {
	localStorage.setItem("simplygoat.aoc.sample."+select.value, sample.value);
	var lines = sample.value.split("\n");
	if (!lines[lines.length-1].length)lines.splice(-1);
	var time = performance.now();
	var alg = days[select.value];
	if (alg.map) lines = lines.map(alg.map);
	if (lines.length == 1) lines = lines[0];
	var run = (fun,lines) => typeof fun!="undefined"? (alg.calc? alg.calc(lines,fun):fun(lines)):"??";
	$id("result").innerHTML = "Results: " + run(alg.easy,lines) + " / " + run(alg.hard,lines) + " (" + (performance.now()-time).toFixed(2) + "ms)";
});
		</script>
	</body>
</html>
