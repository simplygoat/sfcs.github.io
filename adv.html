<html>
	<header>
		<title>Advent of Code: Solutions</title>
	</header>
	<body>
		<div id="result" style="height:1em; background-color:lightgray; border:1px dashed black; padding:.2em; margin:.2em"></div>
		<select id="select"></select>
		<input id="button" type="button" value="Start"></input>
		<textarea id="sample" style="display:block; height:40em; width: 40em; margin-top:1em"></textarea>
		<script>
Array.prototype.cut = function(value) {
	do {
		var index = typeof value == "function"? this.findIndex(value) : this.indexOf(value);
		if (index >= 0) this.splice(index, 1);
	} while(index >= 0);
};
Array.prototype.visit = function(visitor) {
	this.forEach(visitor);
	return this;
};
Array.prototype.collect = function(reduction, initial) {
	return this.reduce((a,c) => {
		reduction(a,c);
		return a;
	},initial||{});
};
const days = [{},
	{
		name: "Sonar Sweep",
		map: line => parseInt(line),
		simple: lines => lines.reduce((a,v,i) => (a + ((i > 0 && v > lines[i-1])? 1:0)), 0),
		hard: lines => days[1].simple(lines.map((v,i,l) => (l.slice(i,i+3).reduce((a,v) => a+v))))
	}, {
		name: "Dive! (Submarine Control)",
		subMarine: {
			depth: 0, position: 0, aim: 0,
			up: function(value) { this.aimed? (this.aim -= value):(this.depth -= value) },
			down: function(value) { this.up(-value) },
			forward: function(value) {
				this.position += value;
				if(this.aimed) this.depth += this.aim * value;
			},
			command: function(c) { 
				this[c[0]](parseInt(c[1]));
				return this;
			},
			result: function() { return this.position * this.depth }
		},
		map: line => line.split(" "),
		simple: lines => lines.reduce((a, c) => a.command(c), Object.assign({}, days[2].subMarine)).result(),
		hard: lines => lines.reduce((a, c) => a.command(c), Object.assign({aimed:true}, days[2].subMarine)).result()
	}, {
		name: "Binary Diagnostic",
		map: line => [...line].map(c => parseInt(c)),
		simple: lines => days[3].simpleProduct(lines.reduce((a,c)=> c.map((v,i)=>v+a[i])).map(v => v > (lines.length/2)? 1:0).join("")),
		simpleProduct: r => parseInt(r,2) * (~parseInt(r,2) & (Math.pow(2,r.length)-1)),
		hard: lines => days[3].hardFilter(lines,true)*days[3].hardFilter(lines,false),
		hardFilter: (lines,invert) => {
			for (var i = 0; lines.length > 1; i++) {
				var commonBit = lines.map(l => l[i]).reduce((a,c)=>a+c) >= (lines.length/2)? (invert?0:1):(invert?1:0);
				lines = lines.filter(l => l[i] == commonBit);
			}
			return parseInt(lines[0].join(""),2);
		}
	}, {
		name: "Giant Squid (Bingo!)",
		board: {
			add: function(line) { this.r.push(line.split(" ").filter(n => n.length > 0).map(n => parseInt(n)).visit((n,i) => this.c[i].push(n))) },
			mark: function(number) { this.c.concat(this.r).forEach(a => a.cut(number)) },
			isFinished: function() { return this.c.some(a => a.length == 0) || this.r.some(a => a.length == 0) }
		},
		simple: lines => days[4].play(lines, bs => bs.find(b => b.isFinished())),
		hard: lines => days[4].play(lines, bs => bs.length == 1? (bs.find(b => b.isFinished())):(bs.cut(b => b.isFinished()))),
		play: function(lines, winCon) {
			var number, numbers = lines[0].split(",").map(n => parseInt(n));
			var board, boards = [];
			for (var i = 1; i < lines.length; i++) lines[i].length? board.add(lines[i]):boards.push(board = Object.assign({}, days[4].board, {c:[[],[],[],[],[]],r:[]}));
			for (var i = 0, board = null; !board; i++)  board = winCon(boards.visit(b => b.mark(number = numbers[i])));
			return board.c.flat().reduce((a,c)=>a+c) * number;
		}
	}, {
		name: "Vent Lines",
		map: line => days[5].parseLine(line.split(" -> ").map(s => s.split(","))),
		parseLine: array => { return {
			from: { x: parseInt(array[0][0]), y: parseInt(array[0][1]) },
			to: { x: parseInt(array[1][0]), y: parseInt(array[1][1]) },
			calc: function(advanced) {
				var result = [];
				if (this.from.x == this.to.x) for (var i = Math.min(this.from.y, this.to.y); i <= Math.max(this.from.y, this.to.y); i++) result.push(this.from.x+","+i);
				else if (this.from.y == this.to.y) for (var i = Math.min(this.from.x, this.to.x); i <= Math.max(this.from.x, this.to.x); i++) result.push(i+","+this.from.y);
				else if (advanced) {
					var from = (this.from.x < this.to.x)?this.from:this.to, to = (this.from.x < this.to.x)?this.to:this.from;
					for (var i = 0; (from.x+i) <= to.x; i++) result.push((from.x+i)+","+((from.y < to.y)?from.y+i:from.y-i));
				}
				return result;
			}
		}},
		simple: lines => days[5].calc(lines, false),
		hard: lines => days[5].calc(lines, true),
		calc: (lines, advanced) => Object.entries(lines.collect((a,l)=>l.calc(advanced).forEach(p => a[p]? a[p]++:a[p]=1))).filter(e => e[1] >= 2).length
	}, {
		name: "Lanternfish Growth Monitor",
		simple: lines => days[6].calc(lines, 80),
		hard: lines => days[6].calc(lines, 256),
		calc: (lines, depth) => {
			var f = lines[0].split(",").map(s => parseInt(s)).collect((a,c)=>a[c]++,[0,0,0,0,0,0,0,0,0]);
			for (var i = 0; i < depth; i++) f = [f[1],f[2],f[3],f[4],f[5],f[6],f[7]+f[0],f[8],f[0]];
			return f.reduce((a,c)=>a+c);
		}
	}
];
const $id = document.getElementById.bind(document);
const select = $id("select");
const day = new Date().getDate();
days.forEach((e,i) => {
	if (i == 0) return;
	var opt = document.createElement("option");
	opt.value = i;
	opt.innerHTML = "Day " + i + ": " + e.name;
	if (i == day) opt.selected = "selected";
	select.appendChild(opt);
});
$id("button").addEventListener("click", function() {
	var lines = $id("sample").value.split("\n");
	var time = performance.now();
	var alg = days[select.value];
	if (alg.map) lines = lines.map(alg.map);
	var run = (fun,lines) => fun? fun(lines):"??";
	$id("result").innerHTML = "Results: " + run(alg.simple,lines) + " / " + run(alg.hard,lines) + " (" + (performance.now()-time).toPrecision(2) + "ms)";
});
		</script>
	</body>
</html>
